---
tags: [lvmama]
title: 初始化订单逻辑
created: '2020-06-04T06:32:34.936Z'
modified: '2020-06-08T08:34:16.009Z'
---

#### 初始化订单逻辑
- 初始化
  - 初始化订单
    - 初始化基本信息
    - 初始化pack和item
    - 是否调用对接平台标识
    - 初始化调用对接平台状态
    - 初始化促销活动
  - 原订单信息保存
  - 保存成人数
  - 保存儿童数
  - 初始化contentMap
- 计算
  - 计算哪个定案子项是主商品订单项
  - 计算订单品类
  - 初始化订单Id
  - 计算各商品的游玩时间
  - 计算资源相关
  - 处理订单以及子订单BUCode
  - 处理支付方式
  - 计算是否可以开发票
  - 计算工作流
  - 计算新工作流
  - 计算订单金额
  - 计算订单返现计算
  - 订单抵扣相关
  - 计算促销活动相关
  - 重新检查并设定定金
  - 计算分销
  - 处理产品经理信息
  - 扣减驴镑
- 设置确认状态

#### 创建订单逻辑
- 保存订单前
  - set 用户id，app版本号等信息
- 保存订单
  - 设置订单状态为取消，原因为初始化取消
  - 从发号器取游玩人id
  - 处理打包信息
  - 构建自订单信息
  - 保存订单
    - 构建订单促销信息
    - 构建子单扩展信息（外币项目）
    - 订单入库
  - 设置 退款成功的金额 为null（原保存订单逻辑）
- 推送驴镑
- 库存扣减
- 设置订单状态为normal
- 保存用户订单
- 保存订单扩展属性。

