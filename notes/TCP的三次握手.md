---
tags: [java/基础知识]
title: TCP的三次握手
created: '2020-06-08T03:38:56.710Z'
modified: '2020-06-08T08:00:58.952Z'
---

# TCP的三次握手

tcp请求头里面有很多组成部分，其中重要的有
序号：Seq，32位
确认号：Ack，32位。只有当标记位的ACK为1的时候，这个Ack才有效、
标记位：顺序是：URG-ACK-PSH-RST-SYN-FIN。这六位，如果某位为1，表示属于打上了这个标记位。
  1. ACK 确认号有效
  2. SYN 发起一个连接
  3. URG 紧急指针有效
  4. PSH 接收方应该尽快把报文交给应用层
  5. RST 重置连接
  6. FIN 释放一个连接

根据上面的内容，tcp三次握手过程如下
1. 标记位为 SYN，表示发起一个连接，通知Seq=x ，这个x一般为1.   SYN-SEND
2. 服务器收到标记位为SYN的请求，明白这是一个连接请求，这时候会返回一个标记位是ACK+SYN的请求，其中确认号Ack=x+1，而序号Seq=y. SYN-RCVD
3. 客户端收到ACK+SYN的请求的时候，明白自己跟服务器的链接是通的，会再返回一个确认。这个确认是一个标记位为ACK的请求，其中标志号Ack=y+1，seq=x+1(直接拿服务端返回的确认号Ack做为自己的请求号Seq). ESTABLISHED

为什么要有三次握手。
为了减少服务器端对于一些无用连接增加服务器开销：比如不需要第三次握手，阶段2，返回丢失，那么客户端会再次发送阶段1.而上次的那个阶段1，服务器就会白白再那里监听。
为了防止已失效的链接请求又传到服务端产生错误:主要防止，客户端的无效请求，服务端当做正常请求处理产生错误。

# TCP的四次挥手
四次挥手是指TCP连接的释放。从上面TCP请求头的标记位中可以看到，有一个FIN的标记位。所以可以推测出肯定是这个需要打上这个标记位通知断开链接的。
1. 标记位为FIN，表示发起释放链接，seq=u。 FIN-WAIT-1（客户端）
2. 服务器收到标记位为FIN的请求，明白需要断开链接。这时候返回一个ACK的请求，其中确认号Ack=u+1，序号新生成一个Seq=v。 FIN-WAIT-2（客户端）
    > 这条回复相当于通知客户端，服务器收到你的关闭连接请求，并始准备关闭链接  CLOSED-WAIT（服务端）。
3. 准备好之后，服务端发出标记位是ACK+FIN的请求。生成一个新的序号Seq=w，并且Ack=u+1，表示和前面的请求属于同一个序列。 LAST-ACK（服务端）。
4. 客户端收到ACK+FIN知道这是一个二次确认的请求，并发送一个标记位是ACK的请求，其中标记号Ack=w+1，而seq就直接取服务端上次请求的Ack的值。seq=u+1。然后客户端进入TIME-WAIT阶段，等待2MSL之后，进入CLOSED阶段。

#### 为什么挥手要4次
因为当，服务器收到关闭连接请求，需要马上回复ACK但是这时候，这时候服务器上并没有准备好没需要处理一些数据。所以就需要等待服务器准备好之后在发送一次请求。
#### 为什么要等待2SML（max segement lifetime）
SML是指一个TCP的最大生命周期，2SML就是一个请求+一个ACK的最大生命周期。为什么要等待这么久是因为有可能当客户端的ACK发出去之后有可能丢失，而如果服务器没有收到ACK，会在1SML后再次发送ACK+FIN。
